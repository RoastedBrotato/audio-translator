version: '3.8'

services:
  asr_streaming:
    build:
      context: ./services/asr_streaming
      dockerfile: Dockerfile
    image: asr_streaming:latest
    ports:
      - "8003:8003"
    volumes:
      # Persist model caches so they don't re-download
      - whisper_cache:/root/.cache/whisper
      - torch_cache:/root/.cache/torch
      - huggingface_cache:/root/.cache/huggingface
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - HF_TOKEN=${HF_TOKEN}
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  translate_py:
    build:
      context: ./services/translate_py
      dockerfile: Dockerfile
    image: translate_py:latest
    ports:
      - "8004:8004"
    volumes:
      # Share HuggingFace cache with ASR service
      - huggingface_cache:/root/.cache/huggingface
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8004/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped

  tts_py:
    build:
      context: ./services/tts_py
      dockerfile: Dockerfile
    image: tts_py:latest
    ports:
      - "8005:8005"
    volumes:
      - tts_cache:/root/.local/share/tts
    environment:
      - COQUI_TOS_AGREED=1
      - CUDA_VISIBLE_DEVICES=0
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8005/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=${DB_NAME:-audio_translator}
      - POSTGRES_USER=${DB_USER:-audio_translator}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-audio_translator_pass}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-audio_translator}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

# Named volumes for persistent model storage
volumes:
  whisper_cache:
  torch_cache:
  huggingface_cache:  # Shared between ASR and translation services
  tts_cache:
  postgres_data:
